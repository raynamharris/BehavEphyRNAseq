---
title: "FMR1"
author: "Rayna M Harris"
date: "2/24/2017"
output: md_document
---

## Loading the data
In the summer of 2016, I processed a bunch of hippocampal tissue samples from WT and FMR1-KO mice that were trained in an active place avoidance task. 

This data was added the the epically large sample collection database contained in the two files  "animals.csv" and "punches.csv" which provided a detailed account of all animals processed and all tissue samples collected. Then, I tidy the dataframe a little bit to get it prepared for RNAseq sample submision.

```{r install packages load data, warning=FALSE, message=FALSE}
#install.packages("tidyr", dependencies=TRUE)
#source("https://bioconductor.org/biocLite.R")
#biocLite("DESeq2")
library("tidyr") 
library("dplyr") ## for filtering and selecting rows
library("plyr")  ## for renmaing factors
library("reshape2") ##  for melting dataframe
library("ggplot2") ## for awesome plots!
library("magrittr") ## to use the weird pipe
library("gplots") ##for making awesome plots
library("cowplot") ## for some easy to use themes
library("DESeq2") ## for differnetial gene expression profiling

# set output file for figures 
knitr::opts_chunk$set(fig.path = '../results/fmr1/')

```

Read the data

```{r ImportData, echo=FALSE, message=FALSE, comment=FALSE, warning=FALSE}
# this starts with data genearated from code described in ../../BehavEphysRNAseq/markdownfiles/02a_tidysamples.R and ../../BehavEphysRNAseq/markdownfiles/02b_KallistoGather.Rmd
colData <- read.csv('../data/rnaseq/fmr1ColData.csv')
rownames(colData) <- colData$RNAseqID
countData <-  read.csv('../data/rnaseq/fmr1CountData.csv', check.names = F, row.names = 1)
```

```{r removeoutliers, echo=FALSE, message=FALSE, comment=FALSE, warning=FALSE}
## remove outliers
colData <- colData %>% filter(RNAseqID != "16-125B", RNAseqID != "16-123B") #set the coldata to be the countbygene df

## colData and countData must contain the exact same sample. I'll use the next three lines to make that happen
savecols <- as.character(colData$RNAseqID) #select the sample name column that corresponds to row names
savecols <- as.vector(savecols) # make it a vector
countData <- countData %>% dplyr::select(one_of(savecols)) # select just the columns that match the samples in colData

```

## DESeq Analysis

Now, I'll look for differential gene expression between the FMR1-KO and WT mice. This analysis was developed by reading the DESEq manual. In many place, I try to provide the chapter where these steps are described in more details.

```{r DESeq, echo=F}
dds <- DESeqDataSetFromMatrix(countData = countData,
                              colData = colData,
                              design = ~ Genotype)
dds <- dds[ rowSums(counts(dds)) > 1, ] ## Pre-filtering
dds$Genotype <- factor(dds$Genotype, levels=c("WT","FMR1")) #factor level
dds <- DESeq(dds) ## 1.4  Differential expression analysi

res <- results(dds, independentFiltering = F) #results
resOrdered <- res[order(res$padj),] # orderd by smallest pval

summary(resOrdered)
head(resOrdered,10)

rld <- rlog(dds, blind=FALSE)
vsd <- varianceStabilizingTransformation(dds, blind=FALSE)
vsd.fast <- vst(dds, blind=FALSE)
head(assay(rld), 3)
```

## Data viz
```{r plots, echo=F}
plotMA(res, ylim=c(-1.5,1))

hist(res$pvalue[res$baseMean > 1], breaks=0:20/20, col="grey50", border="white")

plotCounts(dds, gene=which.min(res$padj), intgroup="Genotype")

## for variance stablized gene expression and log transformed data

```


## pca plot

```{r pca}
pcaData <- plotPCA(rld, intgroup = c( "Genotype", "Conflict"), returnData=TRUE)
pcaData
percentVar <- round(100 * attr(pcaData, "percentVar"))

ggplot(pcaData, aes(PC1, PC2, color=Genotype, label = name)) + geom_point(size=3) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  ylab(paste0("PC2: ",percentVar[2],"% variance")) +
  geom_text() +
  coord_fixed()
```

```{r heatmap}
library("genefilter")
library("pheatmap")
topVarGenes <- head(order(rowVars(assay(rld)),decreasing=TRUE),25)
mat <- assay(rld)[ topVarGenes, ]
mat <- mat - rowMeans(mat)
df <- as.data.frame(colData(rld)[,c("Genotype")])
pheatmap(mat)



## differntiall expressed heatmap
source("resvalsfunction.R")
DEGes <- assay(rld)
contrast1 <- resvals(contrastvector = c("Genotype", "FMR1", "WT"), mypadj = 0.1)
DEGes <- cbind(DEGes, contrast1)
DEGes <- as.data.frame(DEGes) # convert matrix to dataframe
DEGes$rownames <- rownames(DEGes)  # add the rownames to the dataframe
DEGes$pvaljmin <- with(DEGes, pmin(pvalGenotypeFMR1WT)) # create new col with min pval
DEGes <- DEGes %>% filter(pvaljmin < 0.0001)
rownames(DEGes) <- DEGes$rownames
drop.cols <-colnames(DEGes[,grep("padj|pval|rownames", colnames(DEGes))])
DEGes <- DEGes %>% dplyr::select(-one_of(drop.cols))
DEGes <- as.matrix(DEGes)
DEGes <- DEGes - rowMeans(DEGes)
head(DEGes)

## set anntation variables
df <- as.data.frame(colData(dds)[,c("Genotype","Conflict")]) ## matrix to df

# set color breaks
paletteLength <- 30
myBreaks <- c(seq(min(DEGes), 0, length.out=ceiling(paletteLength/2) + 1), 
              seq(max(DEGes)/paletteLength, max(DEGes), length.out=floor(paletteLength/2)))

colorpalette <-  colorRampPalette(c("Deep Sky Blue 3", "white", "red"))( 30 )


pheatmap(DEGes, show_colnames=F, show_rownames = T,
         annotation_col=df, 
         #annotation_colors = ann_colors,
         treeheight_row = 0, treeheight_col = 25,
         #fontsize = 11, 
         #width=4.5, height=3,
         border_color = "grey60" ,
         color = colorpalette,
         #cellwidth = 12, 
         clustering_method="average",
         breaks=myBreaks,
         clustering_distance_cols="correlation" 
         )
```


## Volcano plot

```{r volcanoplot}
with(res, plot(log2FoldChange, -log10(pvalue), pch=20, main="Volcano plot"))
with(subset(res, padj<.05 ), points(log2FoldChange, -log10(pvalue), pch=20, col="red"))
#with(subset(res, abs(log2FoldChange)>1), points(log2FoldChange, -log10(pvalue), pch=20, col="orange"))
#with(subset(res, padj<.05 & abs(log2FoldChange)>1), points(log2FoldChange, -log10(pvalue), pch=20, col="green"))

```

## Session Info
```{r session info}
sessionInfo()
```