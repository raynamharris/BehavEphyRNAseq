---
title: "Kallisto Data Wrangling"
author: "Rayna M Harris"
date: "January 8, 2017"
output: html_document
---

### Before we get started
This Rmd file was built from the R script punches.R. I'd like to make this workflow more reproducible so I'm transfered to Rmd. I may end up adding code from other R scripts.

### Setup

```{r setup}

library("tidyverse")
library("plyr")
library("reshape2")

knitr::opts_chunk$set(fig.path = '../figures/wranglekallisto')
```

### Import ALL the sample data for all the tissue samples collected by Rayna at Woods Hole from 2012-2013

```{r importdata}

punches <- read.csv("../data/rnaseq/punches.csv", header=TRUE)
animals <- read.csv("../data/rnaseq/animals.csv", header=TRUE)
full <- join(animals, punches, by = "Mouse", type = "full", match = "all")
str(full)
```

### Subset the data to keep just the info relevant to the RNAseq samples

This output was saved to a file using the commands and  `write.csv(JA16444samples, "../data/rnaseq/JA16444samples.csv", row.names=FALSE)` and `write.csv(DissociationTest, "../data/rnaseq/sampleinfo.csv", row.names=FALSE)`

```{r WrangleRNAseqMetaData}
JA16444samples <- full %>%
  filter(jobnumber == "JA16444") %>%
  distinct(RNAseqID, Tube, Mouse, Genotype, Conflict, APA, Group, Behavior, E.phy, Punch, Slice, Date, jobnumber)
str(JA16444samples)
head(JA16444samples)

DissociationTest <- full %>%
  filter(Mouse %in% c("15-100", "15-101")) %>%
  filter(jobnumber == "JA16444")  %>% droplevels()
DissociationTest <- DissociationTest[c(1:3, 10:14,16,29:32)] 
DissociationTest <- DissociationTest[c(11,4,8,7,1:3,5:6,9:10)]
names(DissociationTest)[names(DissociationTest)=="notes"] <- "Method"
DissociationTest$Method <- revalue(DissociationTest$Method, c("maddy FACS dissociate" = "dissociated")) 
DissociationTest$Method <- revalue(DissociationTest$Method, c("maddy punch" = "homogenized")) 
head(DissociationTest)
```

### wrangle the FMR1 data
I did this portion of my experiment a little different. Rather than add the photo data to the mail data collection file, I kept this analysis in a separate file and then merged the two.

THe output was saved as `#write.csv(summer2016forRNAseq, "../data/rnaseq/summer2016forRNAseq.csv", row.names=FALSE)`

```{r fmr1data}
summer2016photos <- full %>%
  filter(Year == "Summer2016", Purpose == "Collaboratorium") %>%
  distinct(Mouse, Slice) %>% droplevels()
# This output was saved as a file and used for doing the photo analysis

## then, use the allen brain atlast to annotate the photos
## then read in photo results 
summer2016photos <- read.csv("../data/rnaseq/summer2016photos.csv", header=T, stringsAsFactors = F)

## subset the full punch dataset and keep the relevant columns for the 2016 project
summer2016forRNAseq <- full %>%
  filter(Year == "Summer2016", Purpose == "Collaboratorium") %>%
  distinct(Tube, Mouse, Genotype, Group, Punch, Slice, Date, storagebox) %>% droplevels()

## merge the photo and the punch data
summer2016forRNAseq <- join(summer2016forRNAseq, summer2016photos, by=c("Mouse","Slice"), type = "full", match = "all")
summer2016forRNAseq$Slice <- as.integer(summer2016forRNAseq$Slice) # first make both integers
str(summer2016forRNAseq)
rm(summer2016photos) #don't need this anymore

# reset the Groups to be Yoked, Same, and Conflict
summer2016forRNAseq <- rename(summer2016forRNAseq, c("Group"="APA"))
summer2016forRNAseq$APA <- ifelse(grepl("NoConflict Trained", summer2016forRNAseq$APA), "Same", 
                                  ifelse(grepl("Yoked", summer2016forRNAseq$APA), "Yoked", "Conflict"))
summer2016forRNAseq$APA


## create a T/F column to say if the the same is from the optimal slice or not. 
summer2016forRNAseq$isbest <- ifelse(summer2016forRNAseq$Slice == summer2016forRNAseq$sliceforRNAseq, T,F) 

## filter data to only the BEST slices and CA1, CA3, and DG Samples
summer2016forRNAseq <- summer2016forRNAseq %>%
  filter(isbest == "TRUE") %>% filter(Punch %in% c("CA1")) %>% 
  filter(APA == "Yoked") %>% 
  arrange(Date) %>% droplevels()

## create an RNAseqID (can't have dashes, must be less than 10 characters)
head(summer2016forRNAseq)
summer2016forRNAseq$idealRNAseqID <- as.factor(paste(summer2016forRNAseq$Mouse,summer2016forRNAseq$Slice,sep="_"))
summer2016forRNAseq$idealRNAseqID <- gsub("-", "_", summer2016forRNAseq$idealRNAseqID, fixed = TRUE)
summer2016forRNAseq$RNAseqID <- summer2016forRNAseq$Mouse



### calculate sample sizes
summer2016forRNAseqtotals <- select(summer2016forRNAseq, Genotype, APA, Punch)
summer2016forRNAseqtotals <- count(summer2016forRNAseqtotals, c('Genotype','APA', "Punch"))
summer2016forRNAseqtotals <- dcast(summer2016forRNAseqtotals, Genotype + APA ~ Punch, value.var = "freq")
head(summer2016forRNAseqtotals)
rm(summer2016forRNAseqtotals)
```